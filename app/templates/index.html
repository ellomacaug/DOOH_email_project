<!-- app/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DOOH Email Client</title>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap&subset=cyrillic" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="top-right">
    <a href="/logout" class="secondary-btn" style="border: 2px solid;text-decoration: none;">–í—ã–π—Ç–∏</a>
  </div>
  <h1>üìß DOOH Email Client</h1>

    <form
      hx-post="/send-emails"
      hx-trigger="submitForm"
      hx-target="#status"
      hx-swap="innerHTML"
      method="POST"
      enctype="multipart/form-data"
    >

    <label>1. –®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞:</label>
    <div class="template-tabs" id="template-tabs">
      <div class="template-tab active" data-value="new_rim">–ù–æ–≤—ã–π –¢–¶</div>
      <div class="template-tab" data-value="check_rim">–£–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π –¢–¶</div>
      <div class="template-tab" data-value="check">–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞</div>
      <div class="template-tab" data-value="confirm">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
      <div class="template-tab" data-value="media">–†–æ–ª–∏–∫–∏</div>
      <div class="template-tab" data-value="close">–ó–∞–∫—Ä—ã–≤–∞—é—â–∏–µ</div>
    </div>

    <textarea id="message_template" name="message_template" rows="16" style="width:100%;">{{ default_template }}</textarea>
    <input type="hidden" name="template_name" id="template_name" value="check">

    <label>2. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π Excel —Ñ–∞–π–ª (.xlsx):</label>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <div style="max-width: 70%;">
        –í—ã–±—Ä–∞–≤ –Ω—É–∂–Ω—ã–π —à–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞ —Å–≤–µ—Ä—Ö—É, –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –ø–æ —Å—Å—ã–ª–∫–µ:<br>
        <span style="color:red">*</span> mall ‚Äì –¢–¶<br>
        <span style="color:red">*</span> city ‚Äì –ì–æ—Ä–æ–¥<br>
        <span style="color:red">*</span> email ‚Äì –ü–æ—á—Ç–∞<br>
        * name ‚Äì –ò–º—è (–∏–ª–∏ –ø—É—Å—Ç–æ)<br>
        * rim ‚Äì –ù–æ—Å–∏—Ç–µ–ª—å<br>
        * link ‚Äì –°—Å—ã–ª–∫–∞ –Ω–∞ –§–û/—Ä–æ–ª–∏–∫–∏<br>
        * min ‚Äì –ë–ª–æ–∫ (–º–∏–Ω)<br>
        * sec ‚Äì –•—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂ (—Å–µ–∫)<br>
        </div>
      <button
        type="button"
        id="contacts-template-btn"
        class="secondary-btn"
      >
        –®–∞–±–ª–æ–Ω —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
      </button>
    </div>

    <input
      type="file"
      name="contacts_file"
      required
      id="contacts_file"
      onchange="handleFileChange(this.files[0])"
    >

    <label>–ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:</label>
    <div id="preview"></div>

    <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; color: #949494;">
      <input type="checkbox" id="add-tc-prefix" checked>
      –î–æ–±–∞–≤–∏—Ç—å "–¢–¶" –∫ –Ω–∞–∑–≤–∞–Ω–∏—è–º, –≥–¥–µ –µ–≥–æ –Ω–µ—Ç
    </div>

    <label>3. –ë—Ä–µ–Ω–¥: <span class="hint">${BRAND}</span></label>
    <input type="text" name="brand" list="brand-list" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—ç—Ç—É–∞–ª—å" required>

    <datalist id="brand-list"></datalist>

    <label>4. –ü–µ—Ä–∏–æ–¥: <span class="hint">${PERIOD}</span></label>
    <input type="text" name="period" list="period-list" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 01.09.2025 - 30.04.2026" required>

    <datalist id="period-list"></datalist>

    <label>5. –¢–µ–º–∞ –ø–∏—Å—å–º–∞ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä):</label>
    <div id="subject-preview-box" style="margin-bottom: 20px; font-size: 14px; color: #555; display: none;"></div>

    <label>6. –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–ø–∫—É —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏: <span class="hint">–í –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span></label>
    <input type="text" name="doc" list="doc-list" placeholder="https://example.com/..." style="width:100%;">

    <datalist id="doc-list"></datalist>


    <label>7. –ö–æ–≥–æ –≤ –∫–æ–ø–∏—é (CC) —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:</label>
    <input type="text" name="cc_list" list="cc-list" placeholder="example1@mail.com, example2@mail.com">

    <datalist id="cc-list"></datalist>

    <div style="display: flex; align-items: center; gap: 16px; margin-top: 20px;">
      <button type="button" id="delayed-submit" class="primary-btn">
        <span class="emoji">üì®</span>
        <span class="text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞</span>
      </button>
      <div id="countdown-box" style="display: none; color: #555; align-items: center; gap: 10px;">
        <span id="countdown-text">–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫...</span>
        <button type="button" id="cancel-submit" class="primary-btn cancel-btn">‚õî –û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>

  </form>

  <div id="status"></div>

  <p style="text-align:center;">–°–¥–µ–ª–∞–Ω–æ –ö—Å—é—à–µ–π <3</p>
  <p style="text-align:center;color: #555;font-size: 10px;">https://github.com/ellomacaug/DOOH_email_project</p>

  <script>
    const templates = {{ templates|tojson }};
    const tabs = document.querySelectorAll('#template-tabs .template-tab');
    const textarea = document.getElementById('message_template');
    const hiddenInput = document.getElementById('template_name');
    const contactsBtn = document.getElementById('contacts-template-btn');

    const templateLinks = {
      new_rim: 'https://docs.google.com/spreadsheets/d/1B0f-6vyHJng4F6IAkEKHo7Y4o-p3H1vb/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true',
      check_rim: 'https://docs.google.com/spreadsheets/d/1YZMw48rVNX3a73jUCeBghdMDPvJRzpAs/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true',
      check: 'https://docs.google.com/spreadsheets/d/1B0f-6vyHJng4F6IAkEKHo7Y4o-p3H1vb/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true',
      confirm: 'https://docs.google.com/spreadsheets/d/1YZMw48rVNX3a73jUCeBghdMDPvJRzpAs/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true',
      media: 'https://docs.google.com/spreadsheets/d/1PehBtIvRblqi4eHgjdWezGKo9IRyisSS/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true',
      close: 'https://docs.google.com/spreadsheets/d/1B0f-6vyHJng4F6IAkEKHo7Y4o-p3H1vb/edit?usp=sharing&ouid=115733225928091106688&rtpof=true&sd=true'
    };

    function setTemplate(templateKey) {
      textarea.value = templates[templateKey];
      hiddenInput.value = templateKey;
      contactsBtn.onclick = () => window.open(templateLinks[templateKey], '_blank');
    }

    setTemplate('new_rim');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const templateKey = tab.dataset.value;
        textarea.value = templates[templateKey];
        hiddenInput.value = templateKey;
        setTemplate(tab.dataset.value);
      });
    });
  </script>
  <script>
    const brandInput = document.querySelector('input[name="brand"]');
    const periodInput = document.querySelector('input[name="period"]');
    const subjectPreviewBox = document.getElementById('subject-preview-box');

    function updateSubjectPreview() {
      const brand = brandInput.value.trim();
      const period = periodInput.value.trim();

      const firstRowDiv = document.getElementById('first-row-data');
      if (!firstRowDiv || !brand || !period) {
        subjectPreviewBox.style.display = 'none';
        return;
      }

      const mall = firstRowDiv.dataset.mall || '';
      const city = firstRowDiv.dataset.city || '';
      const subject = `${mall} (–≥. ${city}) // ${brand} // ${period}`;

      subjectPreviewBox.innerText = subject;
      subjectPreviewBox.style.display = 'block';
    }

    brandInput.addEventListener('input', updateSubjectPreview);
    periodInput.addEventListener('input', updateSubjectPreview);
  </script>
  <script>
    function previewExcel(file) {
      if (!file) return;

      const preview = document.getElementById("preview");
      preview.innerHTML = '<div class="loading-spinner"></div>';

      const formData = new FormData();
      formData.append("contacts_file", file);

      const addPrefix = document.getElementById("add-tc-prefix").checked;
      formData.append("add_tc_prefix", addPrefix);

      fetch("/preview-excel", {
        method: "POST",
        body: formData,
      })
        .then(response => {
          if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel");
          return response.text();
        })
        .then(html => {
          preview.innerHTML = html;
          preview.style.border = "none";
          preview.style.padding = "0";
          preview.style.minHeight = "0";
          updateSubjectPreview();
        })
        .catch(error => {
          preview.innerHTML = `<div style="color:red;">‚ùå ${error.message}</div>`;
        });
    }

    let uploadedFile = null;

    function handleFileChange(file) {
      uploadedFile = file;
      previewExcel(file);
    }
    document.getElementById("add-tc-prefix").addEventListener("change", () => {
      if (uploadedFile) {
        previewExcel(uploadedFile);
      }
    });

  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    const delayedBtn = document.getElementById("delayed-submit");
    const countdownBox = document.getElementById("countdown-box");
    const countdownText = document.getElementById("countdown-text");
    const cancelBtn = document.getElementById("cancel-submit");

    const contactsInput = document.getElementById("contacts_file");
    const brandInput = document.querySelector('input[name="brand"]');
    const periodInput = document.querySelector('input[name="period"]');
    const templateInput = document.getElementById("message_template");

    let countdownTimer;
    let secondsLeft = 5;

    function validateForm() {
      if (!contactsInput.files.length) {
        alert("‚ùó –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏.");
        return false;
      }

      if (!brandInput.value.trim()) {
        alert("‚ùó –í–≤–µ–¥–∏—Ç–µ –±—Ä–µ–Ω–¥.");
        return false;
      }

      if (!periodInput.value.trim()) {
        alert("‚ùó –í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥.");
        return false;
      }

      if (!templateInput.value.trim()) {
        alert("‚ùó –í–≤–µ–¥–∏—Ç–µ —à–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞.");
        return false;
      }

      return true;
    }

    delayedBtn.addEventListener("click", () => {
      if (!validateForm()) return;

      secondsLeft = 5;
      countdownText.textContent = `–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ ${secondsLeft} —Å–µ–∫...`;
      countdownBox.style.display = "block";
      delayedBtn.disabled = true;

      countdownTimer = setInterval(() => {
        secondsLeft -= 1;
        if (secondsLeft <= 0) {
          clearInterval(countdownTimer);
          countdownBox.style.display = "none";
          delayedBtn.disabled = false;
          htmx.trigger(form, "submitForm");
        } else {
          countdownText.textContent = `–û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ ${secondsLeft} —Å–µ–∫...`;
        }
      }, 1000);
    });

    cancelBtn.addEventListener("click", () => {
      clearInterval(countdownTimer);
      countdownBox.style.display = "none";
      delayedBtn.disabled = false;
    });
  });
</script>


  <script>
    const fields = [
      { name: 'brand', listId: 'brand-list' },
      { name: 'period', listId: 'period-list' },
      { name: 'cc_list', listId: 'cc-list' },
      { name: 'doc', listId: 'doc-list' }
    ];

    fields.forEach(({ name, listId }) => {
      const input = document.querySelector(`input[name="${name}"]`);
      const datalist = document.getElementById(listId);

      const saved = JSON.parse(localStorage.getItem(name) || '[]');
      saved.slice(-10).forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        datalist.appendChild(option);
      });

      input.addEventListener('blur', () => {
        const value = input.value.trim();
        if (!value) return;
        let values = JSON.parse(localStorage.getItem(name) || '[]');
        if (!values.includes(value)) {
          values.push(value);
          localStorage.setItem(name, JSON.stringify(values.slice(-10)));
        }
      });
    });
  </script>

</body>
</html>
